# Deep Research ãƒªãƒ³ã‚¯æŠ½å‡ºæ©Ÿèƒ½ è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

### 1.1 ç›®çš„
Deep Research ãƒ¬ãƒãƒ¼ãƒˆã«å«ã¾ã‚Œã‚‹ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã‚’ **Obsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼**ï¼ˆ`[^N]`ï¼‰ã«å¤‰æ›ã—ã€References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨å…±ã« Obsidian ã«ä¿å­˜ã™ã‚‹ã€‚

### 1.2 ã‚¹ã‚³ãƒ¼ãƒ—
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ï¼ˆ`<sup data-turn-source-index>`ï¼‰ã®æ¤œå‡º
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ«å°¾ã®ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆæŠ½å‡ºï¼ˆURLãƒ»ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
- å¼•ç”¨ã®è„šæ³¨å½¢å¼å¤‰æ›ï¼ˆ`<sup>` â†’ `[^N]`ï¼‰
- References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆï¼ˆå…¨ã‚½ãƒ¼ã‚¹ã€è„šæ³¨å®šç¾©å½¢å¼ï¼‰
- URLãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ‹ã‚¿ã‚¤ã‚º

### 1.3 ã‚¹ã‚³ãƒ¼ãƒ—å¤–
- ~~ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ³ã‚¯å½¢å¼ï¼ˆ`[ã‚¿ã‚¤ãƒˆãƒ«](URL)`ï¼‰ã§ã®å‡ºåŠ›~~ï¼ˆ**v2.1 ã§å»ƒæ­¢**ï¼‰
- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®å–å¾—ãƒ»ä¿å­˜
- ã‚½ãƒ¼ã‚¹ã®ä¿¡é ¼æ€§è©•ä¾¡
- ãƒªãƒ³ã‚¯å…ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ

### 1.4 è¦ä»¶ï¼ˆãƒ–ãƒ¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒŸãƒ³ã‚°çµæœï¼‰

| é …ç›® | æ±ºå®šå†…å®¹ |
|------|---------|
| æ–‡ä¸­å¼•ç”¨å½¢å¼ | `[^N]`ï¼ˆObsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨ï¼‰ |
| è„šæ³¨ç•ªå· | `data-turn-source-index` ã®å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆéé€£ç¶šå¯ï¼‰ |
| é‡è¤‡å¼•ç”¨ | åŒä¸€ç•ªå·ã‚’å†åˆ©ç”¨ï¼ˆReferences ã«1å›ã®ã¿è¨˜è¼‰ï¼‰ |
| References è¦‹å‡ºã— | `# References` |
| References é…ç½® | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ€å¾Œå°¾ |
| æœªå‚ç…§ã‚½ãƒ¼ã‚¹ | References ã«å«ã‚ã‚‹ï¼ˆå…¨ã‚½ãƒ¼ã‚¹è¨˜è¼‰ï¼‰ |

---

## 2. HTML æ§‹é€ åˆ†æ

### 2.1 ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨æ§‹é€ 

```html
<!-- æ–‡ä¸­ã®å¼•ç”¨ãƒãƒ¼ã‚«ãƒ¼ -->
<source-footnote _nghost-ng-c55987025="" class="ng-star-inserted">
  <sup _ngcontent-ng-c55987025=""
       class="superscript"
       data-turn-source-index="1">
    <!-- å®Ÿéš›ã®ç•ªå·ã¯ CSS ã§è¡¨ç¤º -->
  </sup>
</source-footnote>
```

**ã‚»ãƒ¬ã‚¯ã‚¿**:
- `source-footnote` - å¼•ç”¨è¦ç´ 
- `sup.superscript[data-turn-source-index]` - å¼•ç”¨ç•ªå·

**å±æ€§**:
- `data-turn-source-index`: **1ãƒ™ãƒ¼ã‚¹**ã®ã‚½ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·
  - æ¤œè¨¼æ—¥: 2025-01-12
  - æ¤œè¨¼æ–¹æ³•: ã‚«ãƒ«ãƒ¼ã‚»ãƒ«å±•é–‹æ™‚ã®URLæ¯”è¼ƒ
  - æ¤œè¨¼çµæœ: `data-turn-source-index="1"` â†’ ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆ[0]ã®URLã¨ä¸€è‡´
  - å¤‰æ›å¼: `sourceListIndex = data-turn-source-index - 1`
  - æ³¨æ„: 0ã¯å­˜åœ¨ã—ãªã„ï¼ˆ1ã‹ã‚‰é–‹å§‹ï¼‰
  - æ³¨æ„: éé€£ç¶šã®å¯èƒ½æ€§ã‚ã‚Šï¼ˆ1, 2, 3, 5, 10, 11...ï¼‰

### 2.2 ã‚½ãƒ¼ã‚¹ã‚«ãƒ«ãƒ¼ã‚»ãƒ«æ§‹é€ ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ï¼‰

```html
<sources-carousel-inline _nghost-ng-c3078843332="">
  <sources-carousel id="sources" _nghost-ng-c389433453="">
    <div class="carousel-content">
      <div data-test-id="sources-carousel-source" class="sources-carousel-source">
        <!-- ã‚½ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ï¼ˆå‹•çš„ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ -->
      </div>
    </div>
  </sources-carousel>
</sources-carousel-inline>
```

**æ³¨æ„**: ã‚«ãƒ«ãƒ¼ã‚»ãƒ«å†…ã®ã‚½ãƒ¼ã‚¹è©³ç´°ã¯å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãŸã‚ã€ç›´æ¥ã®ãƒªãƒ³ã‚¯å–å¾—ã¯å›°é›£ã€‚

### 2.3 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ«å°¾ã®ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆæ§‹é€ 

```html
<deep-research-source-lists _nghost-ng-c3369699991="">
  <collapsible-button data-test-id="used-sources-button">
    <span class="gds-title-m">ãƒ¬ãƒãƒ¼ãƒˆã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚½ãƒ¼ã‚¹</span>
  </collapsible-button>

  <!-- ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆæœ¬ä½“ -->
  <div id="used-sources-list">
    <!-- å„ã‚½ãƒ¼ã‚¹ã‚¢ã‚¤ãƒ†ãƒ  -->
    <a data-test-id="browse-web-item-link"
       href="https://example.com/article"
       target="_blank" rel="noopener">
      <span data-test-id="title" class="sub-title">Article Title</span>
      <span data-test-id="domain-name" class="display-name">example.com</span>
    </a>
  </div>
</deep-research-source-lists>
```

### 2.4 Browse ãƒãƒƒãƒ—æ§‹é€ ï¼ˆä»£æ›¿ã‚½ãƒ¼ã‚¹ï¼‰

```html
<a data-test-id="browse-chip-link"
   class="browse-chip"
   href="https://www.help.cbp.gov/s/article/Article-1282"
   target="_blank" rel="noopener noreferrer">
  <span data-test-id="title" class="sub-title">ESTA - How do I pay...</span>
  <span data-test-id="domain-name" class="display-name">help.cbp.gov</span>
</a>
```

---

## 3. è¨­è¨ˆ

### 3.1 ã‚»ãƒ¬ã‚¯ã‚¿å®šç¾©

```typescript
// src/content/extractors/gemini.ts ã«è¿½åŠ 

const DEEP_RESEARCH_LINK_SELECTORS = {
  // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨
  inlineCitation: [
    'source-footnote sup.superscript[data-turn-source-index]',
    'sup.superscript[data-turn-source-index]',
  ],

  // ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ
  sourceListContainer: [
    'deep-research-source-lists',
    '#used-sources-list',
  ],

  // ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆå†…ã®ãƒªãƒ³ã‚¯
  sourceListItem: [
    'a[data-test-id="browse-web-item-link"]',
    'a[data-test-id="browse-chip-link"]',
  ],

  // ã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«
  sourceTitle: [
    '[data-test-id="title"]',
    '.sub-title',
  ],

  // ã‚½ãƒ¼ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³
  sourceDomain: [
    '[data-test-id="domain-name"]',
    '.display-name',
  ],
};
```

### 3.2 å‹å®šç¾©

```typescript
// src/lib/types.ts ã«è¿½åŠ 

/**
 * Deep Research ã®ã‚½ãƒ¼ã‚¹æƒ…å ±
 */
export interface DeepResearchSource {
  /** ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆå†…ã®0ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆDOMé †ï¼‰ */
  index: number;
  /** ã‚½ãƒ¼ã‚¹URL */
  url: string;
  /** ã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ« */
  title: string;
  /** ãƒ‰ãƒ¡ã‚¤ãƒ³å */
  domain: string;
}

/**
 * Deep Research ãƒªãƒ³ã‚¯æŠ½å‡ºçµæœ
 *
 * è¨­è¨ˆæ–¹é‡: ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã®ã¿ã‚’ä¿æŒã—ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã¯
 * HTMLâ†’Markdownå¤‰æ›æ™‚ã« data-turn-source-index ã‹ã‚‰ç›´æ¥å‡¦ç†ã™ã‚‹
 */
export interface DeepResearchLinks {
  /** ã‚½ãƒ¼ã‚¹ä¸€è¦§ï¼ˆã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã®DOMé †ã€0ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ */
  sources: DeepResearchSource[];
}

// ConversationData ã®æ‹¡å¼µ
export interface ConversationData {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  /** Deep Research ã®ãƒªãƒ³ã‚¯æƒ…å ±ï¼ˆoptionalï¼‰ */
  links?: DeepResearchLinks;
}
```

**è¨­è¨ˆæ±ºå®š**:
- `InlineCitation` å‹ã¯**ä¸è¦**
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã¯HTMLå¤‰æ›æ™‚ã« `data-turn-source-index` å±æ€§ã‹ã‚‰ç›´æ¥å‡¦ç†
- ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã¯ `Map<number, DeepResearchSource>` ã¨ã—ã¦ `data-turn-source-index` â†’ ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°

### 3.3 æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯

```typescript
// src/content/extractors/gemini.ts ã«è¿½åŠ 

/**
 * ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‚’æŠ½å‡ºã—ã€data-turn-source-index ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª Map ã‚’æ§‹ç¯‰
 *
 * é‡è¦: data-turn-source-index ã¯ 1ãƒ™ãƒ¼ã‚¹
 * ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã® DOM é †ï¼ˆ0ãƒ™ãƒ¼ã‚¹ï¼‰ã¨ã®å¯¾å¿œ:
 *   data-turn-source-index="N" â†’ sourceList[N-1]
 */
extractSourceList(): DeepResearchSource[] {
  const sources: DeepResearchSource[] = [];

  // ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆå†…ã®ãƒªãƒ³ã‚¯ã‚’å–å¾—
  const sourceLinks = document.querySelectorAll(
    DEEP_RESEARCH_LINK_SELECTORS.sourceListItem.join(',')
  );

  sourceLinks.forEach((link, index) => {
    const anchor = link as HTMLAnchorElement;
    const url = anchor.href;

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
    const titleEl = anchor.querySelector(
      DEEP_RESEARCH_LINK_SELECTORS.sourceTitle.join(',')
    );
    const title = titleEl?.textContent?.trim() || 'Unknown Title';

    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—ï¼ˆURLãƒ‘ãƒ¼ã‚¹å¤±æ•—ã«å‚™ãˆã¦try-catchï¼‰
    const domainEl = anchor.querySelector(
      DEEP_RESEARCH_LINK_SELECTORS.sourceDomain.join(',')
    );
    let domain = domainEl?.textContent?.trim() || '';
    if (!domain) {
      try {
        domain = new URL(url).hostname;
      } catch {
        domain = 'unknown';
      }
    }

    sources.push({
      index,  // 0ãƒ™ãƒ¼ã‚¹ã®é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      url,
      title: this.sanitizeText(title),
      domain,
    });
  });

  return sources;
}

/**
 * ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‹ã‚‰ data-turn-source-index ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª Map ã‚’æ§‹ç¯‰
 *
 * @param sources extractSourceList() ã®çµæœ
 * @returns Map<data-turn-source-index, DeepResearchSource>
 *
 * ä½¿ç”¨ä¾‹:
 *   const map = buildSourceMap(sources);
 *   const source = map.get(5); // data-turn-source-index="5" ã«å¯¾å¿œã™ã‚‹ã‚½ãƒ¼ã‚¹
 */
buildSourceMap(sources: DeepResearchSource[]): Map<number, DeepResearchSource> {
  const map = new Map<number, DeepResearchSource>();

  sources.forEach((source, arrayIndex) => {
    // data-turn-source-index ã¯ 1ãƒ™ãƒ¼ã‚¹
    // arrayIndex=0 â†’ data-turn-source-index=1
    const turnSourceIndex = arrayIndex + 1;
    map.set(turnSourceIndex, source);
  });

  return map;
}

/**
 * Deep Research ãƒªãƒ³ã‚¯æƒ…å ±ã‚’æŠ½å‡º
 */
extractDeepResearchLinks(): DeepResearchLinks {
  const sources = this.extractSourceList();

  return {
    sources,
  };
}
```

**æ³¨è¨˜**: `extractInlineCitations()` ã¯ä¸è¦ã€‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã®å‡¦ç†ã¯ Markdown å¤‰æ›æ™‚ã«è¡Œã†ã€‚

### 3.4 Markdown å¤‰æ›ï¼ˆObsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼ï¼‰

**é‡è¦ãªè¨­è¨ˆæ±ºå®š**:
- v2.1 ã¾ã§ã® `<a>` ã‚¿ã‚°æ–¹å¼ã‹ã‚‰ **Obsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼** ã«å¤‰æ›´
- æ–‡ä¸­: `[^N]` â†’ Obsidian ãŒè‡ªå‹•çš„ã«è„šæ³¨å®šç¾©ã«ã‚¸ãƒ£ãƒ³ãƒ—
- æ–‡æœ«: `[^N]: [ã‚¿ã‚¤ãƒˆãƒ«](URL)` â†’ è„šæ³¨å®šç¾©ï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰

**Obsidian è„šæ³¨æ§‹æ–‡ï¼ˆå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šï¼‰**:
- å‚ç…§: [Obsidian Help - Basic formatting syntax](https://help.obsidian.md/syntax)
- å‚ç…§: [GitHub - obsidian-help/Footnote.md](https://github.com/obsidianmd/obsidian-help/blob/master/Sandbox/Formatting/Footnote.md)

```markdown
æ–‡ä¸­ã®è„šæ³¨å‚ç…§[^1]ã¨åˆ¥ã®å‚ç…§[^bignote]

[^1]: è„šæ³¨ã®å†…å®¹

[^bignote]: è¤‡æ•°æ®µè½ã®è„šæ³¨
    ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã§ç¶™ç¶š
```

### 3.4.1 æ—§ä»•æ§˜ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ³ã‚¯æ–¹å¼ï¼‰ã€v2.1 ã§å»ƒæ­¢ã€‘

v2.1 ã¾ã§ã® `<a>` ã‚¿ã‚°çµŒç”±æ–¹å¼ã¯å»ƒæ­¢ã€‚è©³ç´°ã¯å¤‰æ›´å±¥æ­´ã‚’å‚ç…§ã€‚

### 3.4.2 ç¾è¡Œä»•æ§˜ï¼ˆObsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼ï¼‰ã€v3.0 æ¡ç”¨ã€‘

```typescript
// src/content/markdown.ts

/**
 * URLã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆå±é™ºãªã‚¹ã‚­ãƒ¼ãƒ ã‚’é™¤å»ï¼‰
 */
export function sanitizeUrl(url: string): string {
  const dangerousSchemes = ['javascript:', 'data:', 'vbscript:'];
  const lowerUrl = url.toLowerCase().trim();

  for (const scheme of dangerousSchemes) {
    if (lowerUrl.startsWith(scheme)) {
      return ''; // å±é™ºãªURLã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    }
  }

  return url;
}

/**
 * ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã‚’ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ span ã«å¤‰æ›
 *
 * å¤‰æ›å‰: <source-footnote><sup data-turn-source-index="N">...</sup></source-footnote>
 * å¤‰æ›å¾Œ: <span data-footnote-ref="N">REF</span>
 *
 * æ³¨: æœ€çµ‚çš„ãª [^N] ã¸ã®å¤‰æ›ã¯ Turndown ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã§è¡Œã†
 *     span å†…ã« "REF" ã‚’å«ã‚ã‚‹ã®ã¯ Turndown ãŒç©ºè¦ç´ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ãŸã‚
 *
 * é‡è¦: data-turn-source-index ã¯ 1ãƒ™ãƒ¼ã‚¹ã€éé€£ç¶šã®å¯èƒ½æ€§ã‚ã‚Š
 */
export function convertInlineCitationsToFootnoteRefs(
  html: string,
  sourceMap: Map<number, DeepResearchSource>
): string {
  // ãƒ‘ã‚¿ãƒ¼ãƒ³1: source-footnote ã§ãƒ©ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  let result = html.replace(
    /<source-footnote[^>]*>[\s\S]*?<sup[^>]*?data-turn-source-index="(\d+)"[^>]*?>[\s\S]*?<\/sup>[\s\S]*?<\/source-footnote>/gi,
    (_match, indexStr) => {
      const index = parseInt(indexStr, 10);
      const source = sourceMap.get(index);
      if (source) {
        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æŒ¿å…¥ï¼ˆTurndown ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã§å¤‰æ›ï¼‰
        return `<span data-footnote-ref="${index}">REF</span>`;
      }
      return ''; // ã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å‰Šé™¤
    }
  );

  // ãƒ‘ã‚¿ãƒ¼ãƒ³2: supè¦ç´ ãŒç›´æ¥å­˜åœ¨ã™ã‚‹å ´åˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  result = result.replace(
    /<sup[^>]*?data-turn-source-index="(\d+)"[^>]*?>[\s\S]*?<\/sup>/gi,
    (_match, indexStr) => {
      const index = parseInt(indexStr, 10);
      const source = sourceMap.get(index);
      if (source) {
        return `<span data-footnote-ref="${index}">REF</span>`;
      }
      return '';
    }
  );

  return result;
}

// Turndown ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ span ã‚’ [^N] ã«å¤‰æ›
// (turndown.addRule ã§ç™»éŒ²)
turndown.addRule('footnoteRef', {
  filter: node => {
    return node.nodeName === 'SPAN' && node.hasAttribute('data-footnote-ref');
  },
  replacement: (_content, node) => {
    const index = node.getAttribute('data-footnote-ref');
    return `[^${index}]`;
  },
});

/**
 * sources-carousel-inline è¦ç´ ã‚’é™¤å»
 */
export function removeSourcesCarousel(html: string): string {
  return html.replace(
    /<sources-carousel-inline[\s\S]*?<\/sources-carousel-inline>/gi,
    ''
  );
}

/**
 * References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆObsidian è„šæ³¨å®šç¾©å½¢å¼ï¼‰
 *
 * å‡ºåŠ›å½¢å¼:
 * # References
 *
 * [^1]: [ã‚¿ã‚¤ãƒˆãƒ«1](URL1)
 * [^2]: [ã‚¿ã‚¤ãƒˆãƒ«2](URL2)
 * ...
 *
 * @param sources å…¨ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆ
 * @returns References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® Markdown æ–‡å­—åˆ—
 */
export function generateReferencesSection(
  sources: DeepResearchSource[]
): string {
  if (sources.length === 0) {
    return '';
  }

  const lines: string[] = ['', '# References', ''];

  sources.forEach((source, arrayIndex) => {
    // data-turn-source-index ã¯ 1ãƒ™ãƒ¼ã‚¹
    const footnoteIndex = arrayIndex + 1;
    const safeUrl = sanitizeUrl(source.url);

    if (safeUrl) {
      // [^N]: [ã‚¿ã‚¤ãƒˆãƒ«](URL)
      lines.push(`[^${footnoteIndex}]: [${source.title}](${safeUrl})`);
    } else {
      // URLãŒç„¡åŠ¹ãªå ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿
      lines.push(`[^${footnoteIndex}]: ${source.title}`);
    }
  });

  return lines.join('\n');
}

/**
 * Deep Research ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å¤‰æ›ï¼ˆObsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼ï¼‰
 *
 * @param html å¤‰æ›å¯¾è±¡ã®HTML
 * @param links extractDeepResearchLinks() ã®çµæœ
 */
export function convertDeepResearchContent(
  html: string,
  links?: DeepResearchLinks
): string {
  let processed = html;

  // 1. ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰ï¼ˆ1ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
  let sourceMap = new Map<number, DeepResearchSource>();
  if (links && links.sources.length > 0) {
    sourceMap = buildSourceMap(links.sources);
  }

  // 2. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã‚’ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«å¤‰æ›
  processed = convertInlineCitationsToFootnoteRefs(processed, sourceMap);

  // 3. sources-carousel ã‚’é™¤å»
  processed = removeSourcesCarousel(processed);

  // 4. HTML â†’ Markdown å¤‰æ›ï¼ˆTurndown ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã§ span â†’ [^N]ï¼‰
  const markdown = htmlToMarkdown(processed);

  // 5. References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
  if (links && links.sources.length > 0) {
    return markdown + generateReferencesSection(links.sources);
  }

  return markdown;
}
```

### 3.4.3 å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
HTML å…¥åŠ›
    â†“
1. ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—æ§‹ç¯‰ï¼ˆdata-turn-source-index â†’ ã‚½ãƒ¼ã‚¹æƒ…å ±ï¼‰
    â†“
2. <sup data-turn-source-index="N"> â†’ <span data-footnote-ref="N">REF</span>
   ï¼ˆTurndown ãŒç©ºè¦ç´ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ãŸã‚ã€ãƒ€ãƒŸãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ "REF" ã‚’æŒ¿å…¥ï¼‰
    â†“
3. sources-carousel é™¤å»
    â†“
4. Turndownï¼ˆHTML â†’ Markdownï¼‰
   + ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«: <span data-footnote-ref="N">REF</span> â†’ [^N]
    â†“
5. References ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
    â†“
Markdown å‡ºåŠ›
```

### 3.4.4 å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¯”è¼ƒï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³é–“ï¼‰

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ–‡ä¸­å½¢å¼ | æ–‡æœ«å½¢å¼ | Obsidian å‹•ä½œ |
|-----------|---------|---------|--------------|
| v2.1ï¼ˆå»ƒæ­¢ï¼‰ | `[ã‚¿ã‚¤ãƒˆãƒ«](URL)` | ãªã— | ã‚¯ãƒªãƒƒã‚¯ã§å¤–éƒ¨URLã¸é·ç§» |
| v3.0ï¼ˆç¾è¡Œï¼‰ | `[^N]` | `[^N]: [ã‚¿ã‚¤ãƒˆãƒ«](URL)` | ã‚¯ãƒªãƒƒã‚¯ã§è„šæ³¨å®šç¾©ã¸ã‚¸ãƒ£ãƒ³ãƒ— â†’ ãã“ã‹ã‚‰URLã¸é·ç§»å¯èƒ½ |

---

## 4. å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### 4.1 æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹ï¼ˆObsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼ï¼‰

```markdown
---
id: gemini_deep-research-a1b2c3d4
title: ãƒãƒ¯ã‚¤æ—…è¡Œæº–å‚™ã¨ç¾åœ°æ³¨æ„ç‚¹ãƒ¬ãƒãƒ¼ãƒˆ
source: gemini
type: deep-research
url: https://gemini.google.com/app/xxx
created: 2025-01-11T10:00:00.000Z
modified: 2025-01-11T10:00:00.000Z
tags:
  - ai-research
  - deep-research
  - gemini
message_count: 1
---

# 2026å¹´3æœˆãƒãƒ¯ã‚¤æ¸¡èˆªã«é–¢ã™ã‚‹èª¿æŸ»å ±å‘Šæ›¸

## 1. å…¥å›½æ‰‹ç¶šã

### 1.1 ESTAç”³è«‹

2026å¹´ç¾åœ¨ã€ESTAè²»ç”¨ã¯**$40**ã«æ”¹å®šã•ã‚Œã¦ã„ã‚‹[^1]ã€‚ç”³è«‹ã¯å‡ºç™ºã®72æ™‚é–“å‰ã¾ã§ã«å®Œäº†ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹[^2]ã€‚

## 2. äº¤é€š

ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³é‹è³ƒã¯**$3.00**ã§ã‚ã‚‹[^3]ã€‚å¤§å‹ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹ã¯æŒã¡è¾¼ã¿ä¸å¯[^4]ã€‚

# References

[^1]: [ESTA - How do I pay for my application?](https://www.help.cbp.gov/s/article/Article-1282)
[^2]: [CBP's Electronic System for Travel Authorization](https://uk.usembassy.gov/cbps-electronic-system-for-travel-authorization-esta/)
[^3]: [Honolulu Skyline Rail 2025](https://livinginhawaii.com/honolulu-skyline-rail/)
[^4]: [Rail Operations](https://www.honolulu.gov/dts/rail-operations)
```

### 4.2 ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç‰¹å¾´

| é …ç›® | èª¬æ˜ |
|------|------|
| æ–‡ä¸­å¼•ç”¨ | `[^N]` å½¢å¼ï¼ˆObsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨ï¼‰ |
| è„šæ³¨ç•ªå· | `data-turn-source-index` ã®å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆéé€£ç¶šå¯ï¼‰ |
| References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ | `# References` è¦‹å‡ºã— + è„šæ³¨å®šç¾©ãƒªã‚¹ãƒˆ |
| è„šæ³¨å®šç¾© | `[^N]: [ã‚¿ã‚¤ãƒˆãƒ«](URL)` å½¢å¼ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | DOMPurify ã§ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã€`sanitizeUrl()` ã§å‡¦ç† |
| Obsidian å‹•ä½œ | `[^N]` ã‚¯ãƒªãƒƒã‚¯ã§è„šæ³¨å®šç¾©ã¸ã‚¸ãƒ£ãƒ³ãƒ— |

### 4.3 å¤‰æ›å‰å¾Œã®æ¯”è¼ƒ

| å¤‰æ›å‰ï¼ˆHTMLï¼‰ | å¤‰æ›å¾Œï¼ˆMarkdownï¼‰ |
|---------------|-------------------|
| `ãƒ†ã‚­ã‚¹ãƒˆ<source-footnote><sup data-turn-source-index="1">...</sup></source-footnote>` | `ãƒ†ã‚­ã‚¹ãƒˆ[^1]` |
| `<sources-carousel-inline>...</sources-carousel-inline>` | ï¼ˆå‰Šé™¤ï¼‰ |
| ï¼ˆãªã—ï¼‰ | `# References` + è„šæ³¨å®šç¾©ãƒªã‚¹ãƒˆ |

---

## 5. å®Ÿè£…è¨ˆç”»

### 5.1 Phase 1: å‹å®šç¾©ã¨åŸºæœ¬æ§‹é€ 
**çŠ¶æ…‹**: âœ… å®Œäº†ï¼ˆv2.1ï¼‰

1. `src/lib/types.ts` ã« `DeepResearchSource`, `DeepResearchLinks` ã‚’è¿½åŠ 
2. `ConversationData` ã« `links` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 

### 5.2 Phase 2: æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯
**çŠ¶æ…‹**: âœ… å®Œäº†ï¼ˆv2.1ï¼‰

1. `DEEP_RESEARCH_LINK_SELECTORS` ã‚’è¿½åŠ 
2. `extractSourceList()` ã‚’å®Ÿè£…
3. `buildSourceMap()` ã‚’å®Ÿè£…
4. `extractDeepResearchLinks()` ã‚’å®Ÿè£…
5. `extractDeepResearch()` ã‚’æ›´æ–°ã—ã¦ãƒªãƒ³ã‚¯æƒ…å ±ã‚’å«ã‚ã‚‹

### 5.3 Phase 3: Markdown å¤‰æ›ï¼ˆv3.0 å¤‰æ›´ï¼‰
**çŠ¶æ…‹**: ğŸ”„ è¦æ›´æ–°

| é–¢æ•° | v2.1 çŠ¶æ…‹ | v3.0 å¤‰æ›´ |
|------|----------|----------|
| `sanitizeUrl()` | âœ… å®Ÿè£…æ¸ˆã¿ | å¤‰æ›´ãªã— |
| `escapeHtml()` | âœ… å®Ÿè£…æ¸ˆã¿ | å¤‰æ›´ãªã— |
| `convertInlineCitationsToLinks()` | âœ… å®Ÿè£…æ¸ˆã¿ | â†’ `convertInlineCitationsToFootnoteRefs()` ã«åç§°ãƒ»å®Ÿè£…å¤‰æ›´ |
| `removeSourcesCarousel()` | âœ… å®Ÿè£…æ¸ˆã¿ | å¤‰æ›´ãªã— |
| `convertDeepResearchContent()` | âœ… å®Ÿè£…æ¸ˆã¿ | è„šæ³¨å½¢å¼å¯¾å¿œã«æ›´æ–° |
| `replacePlaceholdersWithFootnoteRefs()` | - | ğŸ†• æ–°è¦è¿½åŠ  |
| `generateReferencesSection()` | - | ğŸ†• æ–°è¦è¿½åŠ  |

### 5.4 Phase 4: ãƒ†ã‚¹ãƒˆï¼ˆv3.0 å¤‰æ›´ï¼‰
**çŠ¶æ…‹**: ğŸ”„ è¦æ›´æ–°

1. è„šæ³¨å‚ç…§å¤‰æ›ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆæ–°è¦ï¼‰
2. References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆæ–°è¦ï¼‰
3. é‡è¤‡å¼•ç”¨ã®ãƒ†ã‚¹ãƒˆï¼ˆåŒä¸€ç•ªå·å†åˆ©ç”¨ï¼‰
4. éé€£ç¶šç•ªå·ã®ãƒ†ã‚¹ãƒˆ
5. çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆã‚µãƒ³ãƒ—ãƒ« HTML ä½¿ç”¨ï¼‰

---

## 6. æ³¨æ„äº‹é …

### 6.1 DOM ã®å‹•çš„æ€§

- `sources-carousel` å†…ã®ã‚½ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã¯å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ï¼ˆé…å»¶èª­ã¿è¾¼ã¿ï¼‰
- æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã§ã¯ã‚«ãƒ«ãƒ¼ã‚»ãƒ«å†…URLã¯ç©º
- **è§£æ±ºç­–**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ«å°¾ã® `deep-research-source-lists` ã‹ã‚‰URLã‚’å–å¾—
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã¯ `data-turn-source-index` å±æ€§ã‹ã‚‰ç•ªå·ã‚’å–å¾—ï¼ˆå¸¸ã«å­˜åœ¨ï¼‰

### 6.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ

- `data-turn-source-index` ã¯ **1ãƒ™ãƒ¼ã‚¹** ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  - æ¤œè¨¼æ—¥: 2025-01-12
  - æ¤œè¨¼æ–¹æ³•: ã‚«ãƒ«ãƒ¼ã‚»ãƒ«å±•é–‹æ™‚ã®URLæ¯”è¼ƒ
- ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã®é…åˆ—ã¯ **0ãƒ™ãƒ¼ã‚¹**
- **å¤‰æ›å¼**: `sourceListIndex = data-turn-source-index - 1`
- ä¾‹: `data-turn-source-index="1"` â†’ `sources[0]`
- **éé€£ç¶šã®å¯èƒ½æ€§**: ç•ªå·ãŒé£›ã¶å ´åˆã‚ã‚Šï¼ˆ1, 2, 3, 5, 10, 11...ï¼‰

### 6.3 é‡è¤‡ã‚½ãƒ¼ã‚¹ã®æ‰±ã„ï¼ˆv3.0 å¤‰æ›´ï¼‰

- åŒä¸€ã‚½ãƒ¼ã‚¹ãŒè¤‡æ•°ã®æ–‡ã§å¼•ç”¨ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹
- **v3.0**: åŒä¸€ã® `[^N]` ã‚’ä½¿ç”¨ï¼ˆReferences ã«1å›ã®ã¿è¨˜è¼‰ï¼‰
- é‡è¤‡ç®¡ç†ã¯ Obsidian ã®è„šæ³¨æ©Ÿèƒ½ãŒè‡ªå‹•å‡¦ç†

### 6.4 æ¬ æãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†

| çŠ¶æ³ | å‡¦ç† |
|------|------|
| ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã«å­˜åœ¨ã—ãªã„ `data-turn-source-index` | å¼•ç”¨ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ï¼ˆç©ºæ–‡å­—ï¼‰ |
| URL ãŒç„¡åŠ¹ï¼ˆå±é™ºã‚¹ã‚­ãƒ¼ãƒ ï¼‰ | è„šæ³¨å®šç¾©ã§ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿å‡ºåŠ› |
| ã‚¿ã‚¤ãƒˆãƒ«ãŒç©º | "Unknown Title" ã‚’ä½¿ç”¨ |
| ãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—å¤±æ•— | "unknown" ã‚’ä½¿ç”¨ |

### 6.5 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

#### URLã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆ`sanitizeUrl()`ï¼‰
- `javascript:`, `data:`, `vbscript:` ã‚¹ã‚­ãƒ¼ãƒ ã¯é™¤å»
- ç„¡åŠ¹ãªURLã¯ç©ºæ–‡å­—ã‚’è¿”ã™
- `sanitizeUrl()` ã§æ¤œè¨¼ã—ã¦ã‹ã‚‰è„šæ³¨å®šç¾©ã«å‡ºåŠ›

#### HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆ`escapeHtml()`ï¼‰
`<span>` ã‚¿ã‚°ç”Ÿæˆæ™‚ã«ä½¿ç”¨:
- `&` â†’ `&amp;`
- `<` â†’ `&lt;`
- `>` â†’ `&gt;`
- `"` â†’ `&quot;`

#### HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆDOMPurifyï¼‰

æŠ½å‡ºã—ãŸ HTML ã¯ `sanitizeHtml()` ã§ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦ã‹ã‚‰å‡¦ç†ã™ã‚‹ã€‚

```typescript
// src/lib/sanitize.ts

/**
 * DOMPurify è¨­å®š:
 * - USE_PROFILES: { html: true } ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å®‰å…¨ãªHTMLè¨±å¯ãƒªã‚¹ãƒˆ
 * - data-turn-source-index ã‚’æ˜ç¤ºçš„ã«è¨±å¯ï¼ˆhook ä½¿ç”¨ï¼‰
 * - ä»–ã® data-* å±æ€§ã¯ãƒ–ãƒ­ãƒƒã‚¯
 */
export function sanitizeHtml(html: string): string {
  DOMPurify.addHook('uponSanitizeAttribute', (node, data) => {
    // data-turn-source-index ã®ã¿è¨±å¯
    if (data.attrName === 'data-turn-source-index') {
      data.forceKeepAttr = true;
    }
    // ä»–ã® data-* å±æ€§ã¯ãƒ–ãƒ­ãƒƒã‚¯
    else if (data.attrName.startsWith('data-')) {
      data.keepAttr = false;
    }
  });

  const result = DOMPurify.sanitize(html, {
    USE_PROFILES: { html: true },
    FORBID_TAGS: ['style'],
  });

  DOMPurify.removeHook('uponSanitizeAttribute');
  return result;
}
```

**é‡è¦**: `data-turn-source-index` å±æ€§ã¯ `convertInlineCitationsToFootnoteRefs()` ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ™‚ã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å±¤

| å±¤ | å¯¾ç­– | ç›®çš„ |
|----|------|------|
| 1 | DOMPurify ã‚µãƒ‹ã‚¿ã‚¤ã‚º | XSS æ”»æ’ƒé˜²æ­¢ã€`data-turn-source-index` ä¿æŒ |
| 2 | `sanitizeUrl()` | å±é™ºãª URL ã‚¹ã‚­ãƒ¼ãƒ é™¤å» |
| 3 | Turndown å¤‰æ› | Markdown ã¸ã®å®‰å…¨ãªå¤‰æ› |

### 6.6 è„šæ³¨å½¢å¼ã®åˆ©ç‚¹ï¼ˆv3.0ï¼‰

| è¦³ç‚¹ | ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ³ã‚¯æ–¹å¼ï¼ˆv2.1ï¼‰ | è„šæ³¨å½¢å¼ï¼ˆv3.0ï¼‰ |
|------|---------------------------|-----------------|
| æœ¬æ–‡ã®å¯èª­æ€§ | ä½ï¼ˆURLãŒé•·ã„å ´åˆï¼‰ | é«˜ï¼ˆ`[^N]` ã®ã¿ï¼‰ |
| References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ | ãªã— | ã‚ã‚Šï¼ˆå…¨ã‚½ãƒ¼ã‚¹ä¸€è¦§ï¼‰ |
| Obsidian äº’æ›æ€§ | æ¨™æº– Markdown | Obsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨ |
| ã‚¯ãƒªãƒƒã‚¯å‹•ä½œ | å¤–éƒ¨URLã¸ç›´æ¥é·ç§» | è„šæ³¨å®šç¾©ã¸ã‚¸ãƒ£ãƒ³ãƒ— â†’ URLã¸é·ç§» |
| é‡è¤‡ç®¡ç† | ä¸è¦ | Obsidian ãŒè‡ªå‹•å‡¦ç† |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦ä»¶ | âŒï¼ˆv2.1 ã§æ¡ç”¨ï¼‰ | âœ…ï¼ˆv3.0 ã§æ¡ç”¨ï¼‰ |

---

## 7. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 7.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆé …ç›® | èª¬æ˜ | å®Ÿè£…çŠ¶æ…‹ |
|-----------|------|---------|
| `extractSourceList()` | URLã€ã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æŠ½å‡º | âœ… å®Ÿè£…æ¸ˆã¿ |
| `buildSourceMap()` | 1ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚° | âœ… å®Ÿè£…æ¸ˆã¿ |
| `convertInlineCitationsToFootnoteRefs()` | `<sup>` â†’ `<span data-footnote-ref>` å¤‰æ› | ğŸ”„ è¦æ›´æ–° |
| `replacePlaceholdersWithFootnoteRefs()` | ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ â†’ `[^N]` å¤‰æ› | ğŸ†• æ–°è¦ |
| `generateReferencesSection()` | References ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ | ğŸ†• æ–°è¦ |
| `sanitizeUrl()` | å±é™ºã‚¹ã‚­ãƒ¼ãƒ ã®é™¤å» | âœ… å®Ÿè£…æ¸ˆã¿ |
| `sanitizeHtml()` | DOMPurify ã«ã‚ˆã‚‹ XSS é˜²æ­¢ | âœ… å®Ÿè£…æ¸ˆã¿ |

### 7.2 ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | å®Ÿè£…çŠ¶æ…‹ |
|---------|---------|---------|
| å¼•ç”¨ãªã— | æœ¬æ–‡ã®ã¿ï¼ˆè„šæ³¨ãªã—ã€References ãªã—ï¼‰ | ğŸ”„ è¦æ›´æ–° |
| ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆãªã— | æœ¬æ–‡ã®ã¿ | ğŸ”„ è¦æ›´æ–° |
| ã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã«å­˜åœ¨ã—ãªã„ `data-turn-source-index` | å¼•ç”¨ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤ï¼ˆç©ºæ–‡å­—ï¼‰ | âœ… |
| é‡è¤‡å¼•ç”¨ï¼ˆåŒã˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¤‡æ•°å›ï¼‰ | åŒä¸€ `[^N]` ã‚’ä½¿ç”¨ã€References ã«1å›ã®ã¿ | ğŸ†• æ–°è¦ |
| éé€£ç¶šç•ªå·ï¼ˆ1, 2, 5, 10...ï¼‰ | ç•ªå·ã‚’ãã®ã¾ã¾ä½¿ç”¨ | ğŸ†• æ–°è¦ |
| ç„¡åŠ¹ãªURLï¼ˆ`javascript:`ï¼‰ | è„šæ³¨å®šç¾©ã§ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿å‡ºåŠ› | ğŸ”„ è¦æ›´æ–° |
| æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ« | æ­£ã—ãå‡ºåŠ› | âœ… |
| ã‚¿ã‚¤ãƒˆãƒ«ã« `<script>` å«ã‚€ | ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦å‡ºåŠ› | âœ… |
| URLã« `()` å«ã‚€ | Markdown ãƒªãƒ³ã‚¯å†…ã§æ­£ã—ãã‚¨ã‚¹ã‚±ãƒ¼ãƒ— | ğŸ”„ è¦ç¢ºèª |
| `data-turn-source-index` å±æ€§ä¿æŒ | DOMPurify ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œã‚‚å±æ€§æ®‹å­˜ | âœ… |

---

## 8. å½±éŸ¿ç¯„å›²

### 8.1 å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|---------|---------|
| `src/lib/types.ts` | `DeepResearchSource`, `DeepResearchLinks`ï¼ˆå¤‰æ›´ãªã—ï¼‰ |
| `src/lib/sanitize.ts` | `sanitizeHtml()`ï¼ˆå¤‰æ›´ãªã—ï¼‰ |
| `src/content/extractors/gemini.ts` | `extractSourceList()`, `extractDeepResearchLinks()`ï¼ˆå¤‰æ›´ãªã—ï¼‰ |
| `src/content/markdown.ts` | `convertInlineCitationsToFootnoteRefs()`, `replacePlaceholdersWithFootnoteRefs()`, `generateReferencesSection()`, `convertDeepResearchContent()` æ›´æ–° |
| `test/content/markdown.test.ts` | è„šæ³¨å½¢å¼å¤‰æ›ãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»æ›´æ–° |

### 8.2 å¾Œæ–¹äº’æ›æ€§

- `ConversationData.links` ã¯ optionalï¼ˆå¤‰æ›´ãªã—ï¼‰
- æ—¢å­˜ã®ãƒ¬ãƒãƒ¼ãƒˆæŠ½å‡ºæ©Ÿèƒ½ã«å½±éŸ¿ãªã—
- **ç ´å£Šçš„å¤‰æ›´**: å‡ºåŠ›å½¢å¼ãŒã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ³ã‚¯ â†’ è„šæ³¨å½¢å¼ã«å¤‰æ›´

---

## 9. æ‰¿èª

| é …ç›® | çŠ¶æ…‹ |
|------|------|
| è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ | å¾…æ©Ÿä¸­ |
| å®Ÿè£…æ‰¿èª | å¾…æ©Ÿä¸­ |

---

## å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|-----------|------|---------|
| 1.0 | 2025-01-11 | åˆç‰ˆä½œæˆ |
| 1.1 | 2025-01-11 | ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜å¯¾å¿œ: Setâ†’é…åˆ—ã€URLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œ |
| 2.0 | 2025-01-12 | å¤§å¹…æ”¹è¨‚: è„šæ³¨å½¢å¼ã‹ã‚‰ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ³ã‚¯å½¢å¼ã«å¤‰æ›´ã€`data-turn-source-index` ã‚’1ãƒ™ãƒ¼ã‚¹ã«ä¿®æ­£ï¼ˆæ¤œè¨¼æ¸ˆã¿ï¼‰ã€`InlineCitation`å‹å‰Šé™¤ã€Referencesã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤ |
| 2.1 | 2025-01-12 | `<a>` ã‚¿ã‚°çµŒç”±æ–¹å¼ã«å¤‰æ›´ï¼ˆäºŒé‡ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œè§£æ±ºï¼‰ã€DOMPurify hook ã«ã‚ˆã‚‹ `data-turn-source-index` ä¿æŒä»•æ§˜è¿½åŠ ã€`escapeMarkdownLink*()` å»ƒæ­¢ã€`escapeHtml()` è¿½åŠ  |
| 3.0 | 2025-01-12 | **Obsidian ãƒã‚¤ãƒ†ã‚£ãƒ–è„šæ³¨å½¢å¼ã«å¤‰æ›´**: `[^N]` å‚ç…§ + `# References` ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã€`data-turn-source-index` ã®éé€£ç¶šç•ªå·ã‚’ãã®ã¾ã¾ä½¿ç”¨ã€é‡è¤‡å¼•ç”¨ã¯åŒä¸€ç•ªå·å†åˆ©ç”¨ã€æœªå‚ç…§ã‚½ãƒ¼ã‚¹ã‚‚ References ã«å«ã‚ã‚‹ |

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å†…å®¹ |
|-------------|------|
| [Deep Research æŠ½å‡ºæ©Ÿèƒ½ è¨­è¨ˆæ›¸](./deep-research-extraction.md) | Deep Research ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åŸºæœ¬æŠ½å‡ºä»•æ§˜ |
| [ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å¼•ç”¨ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã«é–¢ã™ã‚‹èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ](../investigation/inline-citation-collapsed-state.md) | `data-turn-source-index` å±æ€§ã®æœºä¸Šæ¤œè¨¼çµæœ |
| [Markdown äºŒé‡ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œ èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ](../investigation/double-escape-issue.md) | `<a>` ã‚¿ã‚°æ–¹å¼æ¡ç”¨ã®çµŒç·¯ã¨æŠ€è¡“çš„è©³ç´° |
| [Obsidian Help - Basic formatting syntax](https://help.obsidian.md/syntax) | Obsidian è„šæ³¨æ§‹æ–‡ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| [GitHub - obsidian-help/Footnote.md](https://github.com/obsidianmd/obsidian-help/blob/master/Sandbox/Formatting/Footnote.md) | Obsidian è„šæ³¨ã‚µãƒ³ãƒ—ãƒ« |

---

*ä½œæˆæ—¥: 2025-01-11*
*æ›´æ–°æ—¥: 2025-01-12*
*ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.0*
*å‰æ: deep-research-extraction.md v1.1*
